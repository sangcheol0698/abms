# ABMS 도메인 모델

## [시스템 필드]

시스템 필드는 모든 도메인 엔티티에 공통적으로 적용되는 감사/삭제 정보입니다.

### 속성

- `createdAt`: `LocalDateTime` 엔티티가 생성된 날짜 및 시간
- `updatedAt`: `LocalDateTime` 엔티티 정보가 마지막으로 업데이트된 날짜 및 시간
- `createdBy`: `String` 엔티티를 생성한 사용자의 ID
- `updatedBy`: `String` 마지막으로 업데이트한 사용자의 ID
- `deleted`: `Boolean` 논리 삭제 여부 플래그(기본값 false)
- `deletedAt`: `LocalDateTime` 엔티티가 논리 삭제된 날짜 및 시간
- `deletedBy`: `String` 엔티티를 논리 삭제한 사용자의 ID

## [직원 Aggregate]

## 직원 (Employee)

_Aggregate Root_

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `departmentId`: `UUID` 소속 부서 ID (not null)
- `name`: `String` 이름 (길이 최대 10, not null)
- `email`: `Email` 임베디드 값 객체 (컬럼명 `email_address`, not null, unique)
- `joinDate`: `LocalDate` 입사일 (not null)
- `birthDate`: `LocalDate` 생년월일 (not null)
- `position`: `EmployeePosition` 직급 (Enum, STRING, not null)
- `type`: `EmployeeType` 고용 형태 (Enum, STRING, not null)
- `status`: `EmployeeStatus` 재직 상태 (Enum, STRING, not null)
- `grade`: `EmployeeGrade` 등급 (Enum, STRING, not null)
- `resignationDate`: `LocalDate` 퇴사일 (nullable)
- `memo`: `String` 메모 (TEXT, nullable)
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static create()`: 직원을 생성
- `resign()`: 퇴사 처리
- `takeLeave()`: 휴직 처리
- `activate()`: 재직 상태로 활성화
- `updateInfo()`: 직원 정보를 업데이트 (이름, 이메일, 직급, 고용 형태, 등급, 메모)
- `promote()`: 직원의 직급을 승진

### 규칙/제약

- 직원의 이메일은 고유해야 하며, 중복된 이메일은 허용하지 않음
- 직원 생성시 직원의 상태는 `ACTIVE(재직)`로 초기화
- 직원이 퇴사 처리되면 `status`를 `RESIGNED(퇴사)`로 변경하고 `resignationDate`에 퇴사일을 설정
  - 이미 퇴사한 직원은 퇴사 처리할 수 없음
  - 직원의 퇴사일은 반드시 입사일 이후여야 함
- 직원은 `ON_LEAVE(휴직)` 상태로 변경할 수 있다
  - 직원의 휴직 상태는 `ACTIVE(재직)` 상태에서만 변경 가능
- 퇴사한 직원의 정보는 수정할 수 없다
- 직원 정보 수정 시 이메일 중복 검증을 수행하여 중복된 이메일이 등록되지 않도록 함
- 직원이 soft delete될 때 이메일 주소를 `"deleted.{timestamp}.{원래이메일}"` 형식으로 변경하여 중복 검증 충돌을 방지
- 직원은 하나의 부서에만 소속될 수 있으며, `departmentId`는 반드시 유효한 부서 ID여야 함
- 직원 승진시 현재 직급보다 같거나 높은 직급으로만 변경 가능

### 이메일 주소 (Email)

_Value Object_

- `address`: 이메일 주소 값
- 표준 이메일 형식을 정규식으로 검증

### EmployeePosition

_enum_

- 값: `ASSOCIATE(사원)`, `SENIOR_ASSOCIATE(선임)`, `PRINCIPAL(책임)`, `TEAM_LEADER(팀장)`, `CHIEF(수석)`, `DIRECTOR(이사)`,
  `TECHNICAL_DIRECTOR(기술이사)`, `MANAGING_DIRECTOR(상무)`, `VICE_PRESIDENT(부사장)`, `PRESIDENT(사장)`, `CHAIRMAN(회장)`

### EmployeeType

_enum_

- 값: `FULL_TIME(정직원)`, `FREELANCE(프리랜서)`, `OUTSOURCING(외주)`, `PART_TIME(반프리)`

### EmployeeStatus

_enum_

- 값: `ACTIVE(재직)`, `ON_LEAVE(휴직)`, `RESIGNED(퇴사)`

### EmployeeGrade

_enum_

- 값: `JUNIOR(초급)`, `MID_LEVEL(중급)`, `SENIOR(고급)`, `EXPERT(특급)`

### DuplicateEmailException

_Exception_

- 이메일 중복 등록 시 발생하는 예외

## [부서 Aggregate]

## 부서 (Department)

_Aggregate Root_

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `name`: `String` 부서명 (길이 최대 30, not null)
- `code`: `String` 부서코드 (길이 최대 32, not null, unique)
- `type`: `DepartmentType` 부서 유형 (Enum, STRING, not null)
- `leaderEmployeeId`: `UUID` 부서장 직원 ID (nullable)
- `parent`: `Department` 상위 부서 (nullable, lazy loading)
- `children`: `List<Department>` 하위 부서 목록 (1:N 관계, cascade persist/merge)

### 행위(메서드)

- `static createRoot()`: 최상위 부서(루트)를 생성
- `static create()`: 하위 부서를 생성 (상위 부서 연결)
- `getOrganizationChart()`: 부서 트리를 반환 (부서, 하위 부서, 하위 부서의 하위 부서, ...)
- `getOrganizationChartWithEmployees`: 부서 트리와 부서에 소속된 직원 목록을 반환

### 규칙/제약

- 부서의 코드는 고유해야 하며, 중복된 코드는 허용하지 않음
- 부서는 계층구조를 가지며, 하나의 상위 부서에 여러 하위 부서가 소속될 수 있음
- 최상위 부서(루트)는 상위 부서가 없음 (`parent`가 null)
- 하위 부서 생성 시 반드시 유효한 상위 부서가 있어야 함
- 부서 간 부모-자식 관계는 양방향으로 관리됨
- 부서장(`leaderEmployeeId`)은 반드시 해당 부서에 소속된 직원이어야 함
- 부서의 부서장은 공석일 수 있음 (nullable)

### 부서 코드 규칙
- 코드 형식 : `prefix(ABC)` + `숫자4자리`
- 숫자를 보고 상위 본부/담당을 유추할 수 있는 계층형 코드 구조

| 계층 | 자리 | 설명 | 예시                                 |
| :--- | :--- | :--- |:-----------------------------------|
| **전사** | `0000` (고정) | 최상위 루트 조직 식별자 | ABC0000 ((주)애버커스)                  |
| **본부** | 천의 자리 | 기능별 최상위 본부 구분 | ABC1000 (경영기획본부), ABC4000 (연구개발본부) |
| **담당/연구소** | 백의 자리 | 본부 산하의 담당 또는 연구소 구분 | ABC2100 (통신이행담당), ABC4100 (기술연구소)  |
| **팀** | 십의 자리, 일의 자리 | 담당 산하의 개별 팀 구분 | ABC2101 (고객정보팀), ABC4101 (플랫폼R&D팀) |

### DepartmentType

_enum_

- 값: `COMPANY(전사)`, `DIVISION(본부)`, `GROUP(담당)`, `TEAM(팀)`, `LAB(연구소)`, `TF(TF)`
- 

## [ 급여 이력 Aggregate ]

_Aggregate Root_

## 급여 (Payroll)

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `employeeId`: `UUID` 직원 ID (not null)
- `annualSalary`: `Moeny` 급여 (not null)
- `Period`: `Period` 급여 기간 (not null)
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static startWith()`: 급여 이력을 생성
- `close`: 기존 이력 `endDate`를 설정하여 close

### 규칙/제약

- 직원의 첫 급여 이력이 생성되면 `startDate`는 급여 시작 날짜로 설정되고 `endDate`는 `null`로 설정
- 직원의 또 다른 급여 이력이 생성되면 기존 급여 이력의 `endDate`를 새로운 급여 시작 날짜로 설정
- 직원의 현재 급여를 조회하려면 `endDate`가 `null`인 급여 이력을 조회
- 급여 이력은 `startDate`가 `endDate`보다 작거나 같아야 함

## Period (기간)

_Value Object_

### 속성(필드)

- `startDate`: 시작 날짜
- `endDate`: 종료 날짜

### 규칙/제약

- `startDate`는 `endDate`보다 작거나 같아야 함

## Money (금액)

_Value Object_

### 속성(필드)

- `amount`: 금액

### 행위(메서드)

- `static wons()`: 한국 돈(원) 단위로 금액을 생성
- `zero()`: 금액 0으로 생성
- `add()`: 금액 더하기
- `subtract()`: 금액 빼기
- `multiply()`: 금액 곱하기
- `divide()`: 금액 나누기
- `isGreaterThan()`: 금액이 주어진 금액보다 크면 true 반환

### 규칙/제약

- 현재 `amount`는 한국 돈(원) 단위로만 관리됨

## [ 협력사 Aggregate ]

## 협력사 (Party)

_Aggregate Root_

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `name`: `String` 협력사명 (길이 최대 50, not null)
- `ceoName`: `String` CEO 이름 (길이 최대 30, nullable)
- `salesRepName`: `String` 영업 담당자 이름 (길이 최대 30, nullable)
- `salesRepPhone`: `String` 영업 담당자 전화번호 (길이 최대 20, nullable)
- `salesRepEmail`: `String` 영업 담당자 이메일 (길이 최대 100, nullable)
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static create()`: 협력사를 생성
- `update()`: 협력사 정보를 업데이트

### 규칙/제약

- 협력사명은 필수
- Soft Delete 지원

## [ 프로젝트 Aggregate ]

## 프로젝트 (Project)

_Aggregate Root_

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `partyId`: `UUID` 협력사 ID (not null)
- `leadDepartmentId` : UUID 주관 부서 ID (not null, 손익 귀속 부서)
- `code`: `String` 프로젝트 코드 (길이 최대 32, not null, unique)
- `name`: `String` 프로젝트명 (길이 최대 100, not null)
- `description`: `String` 프로젝트 설명 (길이 최대 500, nullable)
- `status`: `ProjectStatus` 프로젝트 상태 (Enum, STRING, not null)
- `contractAmount`: `Money` 계약 금액 (not null)
- `period`: `Period` 프로젝트 기간 (not null)
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static create()`: 프로젝트를 생성
- `update()`: 프로젝트 정보를 업데이트
- `complete()`: 프로젝트를 완료 상태로 변경
- `cancel()`: 프로젝트를 취소

### 규칙/제약

- 프로젝트 코드는 고유해야 함 (unique)
- 협력사 ID는 유효한 협력사여야 함
- 프로젝트 종료일은 시작일 이후여야 함
- Soft Delete 지원
- 프로젝트의 총 계약 금액은 하위 매출 계획(ProjectRevenuePlan)들의 합과 일치해야 함 (검증 로직 필요)

### ProjectStatus

_enum_

- 값: `SCHEDULED(예약)`, `IN_PROGRESS(진행중)`, `COMPLETED(완료)`, `CANCELLED(취소)`


## 프로젝트 매출 계획 (ProjectRevenuePlan)

_Entity_ (Project의 Child)

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `projectId`: `UUID` 프로젝트 ID (FK, not null)
- `sequence` : `Integer` 순서 (not null)
- `revenueMonth` : `String` 매출 인식 년월 (Format: YYYYMM, not null)
- `type`: `RevenueType` 매출 구분 (Enum, STRING, not null)
- `amount`: `Money` 매출 금액 (공급가액, not null)
- `isIssued`: `Boolean` 세금계산서 발행 여부 (default false)
- `description`: `String` 비고 (예: 1차 중도금)
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static create()`: 특정 월의 매출 계획 수립
- `issue()`: 세금계산서 발행 처리 (isIssued = true)
- `cancel()`: 발행 취소
- `adjustAmount()`: 금액 조정 (미발행 상태에서만 가능)

### 규칙/제약

- `revenueMonth`는 프로젝트 기간과 무관하게 설정 가능 (잔금 수금 지연 등 고려)
- 이미 발행된 (isIssued=true) 계획은 금액을 수정할 수 없음
- 동일 프로젝트 내 매출 계획의 총합은 프로젝트 계약금액과 일치해야 함
- 동일 프로젝트 내 매출 계획의 순서는 중복될 수 없음


### RevenueType

_enum_

- 값: `DOWN_PAYMENT(착수금)`, `INTERMEDIATE_PAYMENT(중도금)`, `BALANCE_PAYMENT(잔금)`, `MAINTENANCE(유지보수)`, `ETC(기타)`


## [ 프로젝트 투입 Aggregate ]

## 프로젝트 투입 (ProjectAssignment)

_Aggregate Root_

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `projectId`: `UUID` 프로젝트 ID (not null)
- `employeeId`: `UUID` 직원 ID (not null)
- `assignmentRole`: `String` 투입 역할 (길이 최대 50, nullable)
- `assignmentRate`: `Double` 투입률 (Man-Month 기준, 0.0 ~ 1.0, nullable)
- `period`: `Period` 투입 기간 (not null)
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static assign()`: 직원을 프로젝트에 배정
- `unassign()`: 프로젝트 투입 해제 (종료일 설정)
- `updateRate()`: 투입률 변경

### 규칙/제약

- 직원 ID는 유효한 직원이어야 함
- 계약 ID는 유효한 계약이어야 함
- 투입률(assignmentRate)은 0.0 초과 1.0 이하여야 함
- 투입 종료일은 시작일 이후여야 함
- Soft Delete 지원
- 원가 계산의 정확성을 위해 투입 기간은 '월(Month)' 단위로 분할 저장되는 것을 권장함
예: 3월 15일 ~ 4월 20일 투입 시 -> [3월 0.5MM], [4월 0.6MM] 두 개의 레코드로 관리


## [ 비용 정책 Aggregate ]
직원 유형별 간접비/판관비 요율 관리

## 직원 원가 정책 (EmployeeCostPolicy)

_Aggregate Root_

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `applyYear`: `Integer` 적용 연도 (예: 2026, not null)
- `employeeType`: `EmployeeType` 집직원 유형 (Enum, not null)
- `directOverheadRate`: `Double` 제경비율 (0.0 ~ 1.0, not null, default 0.0)
- `generalAdminRate`: `Double` 판관비율 (0.0 ~ 1.0, not null, default 0.0)
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static define()`: 특정 연도 및 유형의 정책 정의
- `updateRates()`: 요율 수정

### 규칙/제약

- 동일한 `applyYear`와 `employeeType` 조합은 중복될 수 없음
- 요율은 음수가 될 수 없음
- 원가 계산 시 (1 + 제경비율 + 판관비율) 계수로 활용됨


## [ 성과 분석 Aggregate ]
배치 작업을 통해 집계된 월별 손익 데이터

## 프로젝트 월별 집계 (ProjectMonthlySum)

_Aggregate Root_

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `projectId`: `UUID` 프로젝트 ID (not null)
- `targetMonth`: `String` 집계 대상 년월 (YYYYMM, not null)
- `revenueAmount`: `Money` 확정 매출액 (세금계산서 기준)
- `costAmount`: `Money` 확정 원가액 (계산식: (투입MM × 급여) + (투입MM × 제경비) + (투입MM × 판관비)) 
- `profitAmount`: `Money` 확정 이익금 (매출(revenueAmount) - 원가(costAmount))
- `isClosed`: `Boolean` 마감 여부 (true일 경우 배치 재계산 제외)
- `closedAt`: `LocalDateTime` 마감 일시
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static create()`: 배치 실행 시 집계 정보
- `close()`: 해당 월의 실적을 마감 처리 (수정 불가)

### 규칙/제약

- `projectId`와 `targetMonth`의 조합은 유일해야 함 (Unique Constraint)
- `isClosed`가 `true`인 상태에서는 배치 작업에 의해 값이 변경되지 않아야 함
- `profitAmount`는 `revenueAmount - costAmount`로 계산됨


## [ 계정 Aggregate ]

## 계정 (Account)

_Aggregate Root_

### 속성(필드)

- `id`: `UUID` 고유 식별자 (AbstractEntity)
- `employeeId`: `UUID` 직원 ID (not null)
- `username`: `Email` 사용자명 (이메일, not null, unique)
- `password`: `String` 암호화된 비밀번호 (not null)
- `token`: `String` JWT 토큰 또는 리프레시 토큰 (길이 최대 500, nullable)
- `isValid`: `Boolean` 계정 활성화 여부 (not null, default true)
- `loginFailCount`: `Integer` 로그인 실패 횟수 (not null, default 0)
- 시스템 필드: BaseEntity의 감사/삭제 필드 일괄 적용

### 행위(메서드)

- `static create()`: 계정을 생성
- `login()`: 로그인 처리 (비밀번호 검증, 실패 횟수 관리)
- `logout()`: 로그아웃 처리 (토큰 제거)
- `resetPassword()`: 비밀번호 재설정
- `deactivate()`: 계정 비활성화
- `activate()`: 계정 활성화

### 규칙/제약

- 사용자명(이메일)은 고유해야 함 (unique)
- 직원 ID는 유효한 직원이어야 함
- 로그인 실패 횟수가 5회 이상이면 계정 자동 비활성화
- 비밀번호는 암호화하여 저장
- Soft Delete 지원
